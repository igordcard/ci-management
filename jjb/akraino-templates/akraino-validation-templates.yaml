---
- job-template:
    id: akraino-validation-docker-multiarch
    name: 'validation-{stream}-docker'
    project-type: multijob
    disabled: '{obj:disabled}'
    node: 'centos7-builder-2c-1g'
    build-timeout: 90

    parameters:
      - validation-job-parameters:
          project: '{project}'
          branch: '{branch}'
          stream: '{stream}'

    properties:
      - throttle:
          max-per-node: 1
          option: 'project'
      - build-blocker:
          use-build-blocker: true
          blocking-jobs:
            - 'validation-docker-.*'
          block-level: 'NODE'
    scm:
      - validation-infra-gerrit-scm:
          jenkins-ssh-credential: '{jenkins-ssh-credential}'
          git-url: '{git-url}/{project}.git'
          refspec: ''
          refs_tag: '{refs_tag}'
          stream: '{stream}'
          submodule-recursive: false
          submodule-timeout: '{submodule-timeout}'
          submodule-disable: false
          choosing-strategy: default

    triggers:
      # Build nigtly at 12:10 AM
      - timed: '10 0 * * *'

    builders:
      - multijob:
          name: 'build validation images'
          execution-type: PARALLEL
          projects:
            - name: 'validation-docker-build-amd64-{stream}'
              <<: *docker-build-job-settings
            - name: 'validation-docker-build-arm64-{stream}'
              <<: *docker-build-job-settings
      - multijob:
          name: 'publish validation manifests'
          condition: SUCCESSFUL
          execution-type: PARALLEL
          projects:
            - name: 'validation-docker-manifest-{stream}'
              <<: *docker-build-job-settings

    publishers:
      - email:
          recipients: >
            cristina.pauna@enea.com
            juha.kosonen@nokia.com


- job-template:
    id: akraino-validation-docker-specific-arch
    name: 'validation-docker-build-{arch_tag}-{stream}'
    disabled: '{obj:disabled}'
    node: '{slave_label}'
    build-timeout: 75

    parameters:
      - validation-job-parameters:
          project: '{project}'
          branch: '{branch}'
          stream: '{stream}'
          arch_tag: '{arch_tag}'

    properties:
      - build-blocker:
          use-build-blocker: true
          blocking-jobs:
            - 'validation-docker-build-.*'
          block-level: 'NODE'
    scm:
     - validation-infra-gerrit-scm:
          jenkins-ssh-credential: '{jenkins-ssh-credential}'
          git-url: '{git-url}/{project}.git'
          refspec: ''
          refs_tag: '{refs_tag}'
          stream: '{stream}'
          submodule-recursive: false
          submodule-timeout: '{submodule-timeout}'
          submodule-disable: false
          choosing-strategy: default

    builders:
      - lf-infra-docker-login:
          global-settings-file: global-settings
          settings-file: '{mvn-settings}'
      - conditional-step:
          condition-kind: regex-match
          regex: '^tags$'
          label: '{refs_tag}'
          steps:
            - shell: |
                #!/bin/bash -ex
                echo "export TAG_VER=$STREAM"  >> tag_version.sh
      - shell: |
          #!/bin/bash -ex
          if [ -f tag_version.sh ]; then source tag_version.sh; fi
          make -k -C docker push-all
          rm -f tag_version.sh
      - shell: |
          #!/bin/bash -ex
          docker system prune -af

- job-template:
    id: akraino-validation-docker-manifest
    name: 'validation-docker-manifest-{stream}'
    node: 'ubuntu1604-docker-8c-8g'
    build-timeout: 15

    parameters:
      - validation-job-parameters:
          project: '{project}'
          branch: '{branch}'
          stream: '{stream}'

    disabled: '{obj:disabled}'

    scm:
     - validation-infra-gerrit-scm:
          jenkins-ssh-credential: '{jenkins-ssh-credential}'
          git-url: '{git-url}/{project}.git'
          refspec: ''
          refs_tag: '{refs_tag}'
          stream: '{stream}'
          submodule-recursive: false
          submodule-timeout: '{submodule-timeout}'
          submodule-disable: false
          choosing-strategy: default

    builders:
      - lf-infra-docker-login:
          global-settings-file: global-settings
          settings-file: '{mvn-settings}'
      - conditional-step:
          condition-kind: regex-match
          regex: '^tags$'
          label: '{refs_tag}'
          steps:
            - shell: |
                #!/bin/bash -ex
                echo "export TAG_VER=$STREAM"  >> tag_version.sh
      - shell: |
          #!/bin/bash -ex
          if [ -f tag_version.sh ]; then source tag_version.sh; fi
          for sd in docker/*/.; do make -k -C $sd .push_manifest; done
          rm -f tag_version.sh

- job-template:
    id: akraino-validation-lab-daily
    name: 'validation-{validation_lab}-daily-{stream}'
    concurrent: true
    node: '{build-node}'
    parameters:
      - {'lab_params'}
    builders:
      - trigger-builds:
          - project: 'bluval-daily-{stream}'
            predefined-parameters:
              LAB_SILO={validation_lab}
            same-node: true
            current-parameters: true
            block: true

- job-template:
    id: bluval-run-daily-tests
    name: 'bluval-daily-{stream}'
    concurrent: true
    node: '{build-node}'
    parameters:
      - string:
          name: DEPLOY_SCENARIO
          default: ''
      - {'bluval-defaults'}

    scm:
      - git:
          credentials-id: '{jenkins-ssh-credential}'
          url: '{git-url}/validation.git'
          refspec: ''
          branches:
            - 'refs/heads/{branch}'
          skip-tag: true
          wipe-workspace: true
          submodule:
            disable: true
            recursive: false
            timeout: '{submodule-timeout}'
          choosing-strategy: default

    builders:
      - description-setter:
          description: "POD: $NODE_NAME"
      - lf-infra-create-netrc:
          server-id: logs
      - shell: !include-raw-escape:
        - ../shell/run_bluval.sh

    publishers:
      - logparser:
          use-project-rules: true
          parse-rules: "./bluval/rules.txt"
          unstable-on-warning: true
          fail-on-error: true
          show-graphs: false
